# ìë°”ìŠ¤í¬ë¦½íŠ¸ 12. í”„ë¡œë¯¸ìŠ¤ ê°œë…ë¶€í„° í™œìš©ê¹Œì§€ JavaScript Promise

Promise

1. Promise is Object for asynchronous operation.
2. state: pending(operation ìˆ˜í–‰ì¤‘) -> fulfilled(operation ìˆ˜í–‰ì„±ê³µ) or rejected(operation ì‹¤íŒ¨)
3. Producer: ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ì„œ ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ëƒ„
4. Consumer: ì›í•˜ëŠ” ë°ì´í„°ë¥¼ ì†Œë¹„

```jsx
1. Producer
// when new Promise is created, the excutor runs automatically.
const promise = new Promise((resolve, rejcet) => {
	// doing some heavy work (network, read files)
	console.log('doing something....');
	setTimeout(() => {
		resolve('ellie'); // resolve ê°€ ì‘ë™í•¨
	}, 2000); // 2ì´ˆ ë’¤ì— ì½”ë“œê°€ ì˜ ì‘ë™í•˜ë©´
})

// when use 'reject'
const promise = new Promise((resolve, rejcet) => {
	// doing some heavy work (network, read files)
	console.log('doing something....');
	setTimeout(() => {
		reject(new Error('no network')); // Error ë¼ëŠ” ê°ì²´ ì‚¬ìš©
		// Error ë¥¼ ì‘ì„±í•  ë•ŒëŠ” ì–´ë–¤ ì—ëŸ¬ê°€ ë°œìƒí–ˆëŠ”ì§€ ì˜ ì‘ì„±í•´ì•¼í•¨
	}, 2000);
})
```

```jsx
2. Consumer: then, catch, finally
// promise ê°€ ì˜ ì‘ë™í•˜ë©´
// .then valueì˜ ê°’ì„ ë°›ì•„ì„œ ê¸°ëŠ¥(í•¨ìˆ˜)ìœ¼ë¡œ ì „ë‹¬
promise//
	.then((value) => {
		console.log(value);
	});
// catch ë¡œ ì—ëŸ¬ ë‹¤ë£¨ê¸°
	.catch(error => {
		console.log(error);
	})
// finally, ì„±ê³µí•˜ë“  ì‹¤íŒ¨í•˜ë“  ì‹¤í–‰í•¨
	.finally(() => {
		console.log('finally');
	});
```

```jsx
3. Promise chaining
const fetchNmber = new Promise((resolve, reject) => {
	setTimeout(() => resolve(1), 1000);
});

// .then ì—ì„œëŠ” value ê°’ì„ ë°”ë¡œ ì „ë‹¬í•´ë„ ë˜ê³ 
// ë˜ ë‹¤ë¥¸ ë¹„ë™ê¸°ì¸ promise ë¥¼ ì „ë‹¬í•´ë„ ë¨
fetchNmber // resolve(1)ì¸ 1ì´ ì „ë‹¬
.then(num => num * 2); // 1 => 1*2
.then(num => num * 3); // 2 => 2*3
.then(num => { // 6
	return new Promise((resolve, reject) => {
		setTimeout(() => resolve(num - 1), 1000); // 6 - 1
	});
})
.then(num => console.log(num)); // 5 => 5
```

```jsx
4. Error Handling
const getHen = () =>
	new Promise((resolve, reject) => {
		setTimeout(() => resolve('ğŸ”'), 1000);
	});
const getEgg = hen =>
	new Promise((resolve, reject) => {
		setTimeout(() => resolve(`${hen} => ğŸ¥š`), 1000);
	});
const cook = egg =>
	new Promise((resolve, reject) => {
		setTimeout(() => resolve(`${egg} => ğŸ³`), 1000);
	});

// callback í•¨ìˆ˜ë¥¼ ë°›ì•„ì˜¬ ë•Œ
// ë°›ì•„ì˜¨ ì¸ìê°€ 1ê°œì´ê³  ë°”ë¡œ í•¨ìˆ˜ì— 1ê°œë§Œ ë„˜ê¸¸ë•ŒëŠ”
// ì¸ì ìƒëµì´ ê°€ëŠ¥í•¨
getHen()
	.then(getEgg)
	.then(cook)
	.then(console.log);
//PromiseÂ {<pending>}
//	[[Prototype]]: Promise
//	[[PromiseState]]: "fulfilled"
//	[[PromiseResult]]: undefined
// ğŸ” => ğŸ¥š => ğŸ³

// ì¤‘ê°„ì— ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤ë©´â“â“
const getHen = () =>
	new Promise((resolve, reject) => {
		setTimeout(() => resolve('ğŸ”'), 1000);
	});
const getEgg = hen =>
	new Promise((resolve, reject) => {
		setTimeout(() => reject(new Error(`error! ${hen} => ğŸ¥š`)), 1000);
	});
const cook = egg =>
	new Promise((resolve, reject) => {
		setTimeout(() => resolve(`${egg} => ğŸ³`), 1000);
	});

getHen()
	.then(getEgg)
	.catch(error => {
		return 'ğŸ';
	})
	.then(cook)
	.then(console.log)
	.catch(console.log);

// PromiseÂ {<pending>}
// 	[[Prototype]]: Promise
//	[[PromiseState]]: "fulfilled"
//	[[PromiseResult]]: undefined
// ğŸ => ğŸ³
```

```jsx
5. Callback -> Promise ë°”ê¾¸ê¸°

class UserStorage {
	// ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ì„ ì‹œë„í•  ë•Œ
	loginUser(id, password, onSuccess, onError) {
		setTimeout(() => {
			if(
				(id === 'ellie' && password === 'dream') ||
				(id === 'coder' && password === 'academy')
			) {
				onSuccess(id);
			} else {
				onError(new Error('not found'));
			}
		}, 2000);
	}
	// ì‚¬ìš©ìê°€ ì—­í™œì„ ë°›ì•„ì˜¬ ë•Œ
	getRoles(user, onSuccess2, onError2) {
		setTimeout(() => {
			if(user === 'ellie') {
				onSuccess2({name: 'ellie', role: 'admin'});
			} else {
				onError2(new Error('no access'));
			}
		}, 1000);
	}
}

const userStorage = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
userStorage.loginUser(
	id,
	password,
	user => { // user === onSuccess(id)
		userStorage.getRoles(
			user, // user === id
			userWithRole => { // userWithRole === onSuccess2
				alert(`Hello ${userWithRole.name}, you have a ${userWithRole.role} role`)
			},
			error => {
				console.log(error);
			}
		);
	},
	error => {
		console.log(error);
	}
);

//------------------------------------------------------------
class UserStorage {
	loginUser (id, password) {
		return new Promise((resolve, reject) => {
			setTimeout(() => {
			if(
					(id === 'ellie' && password === 'dream') ||
					(id === 'coder' && password === 'academy')
				) {
					resolve(id); // ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ resolveì— idë¥¼ ì¸ìë¡œ ì „ë‹¬
				} else {
					reject(new Error('not found'));
				}
			}, 2000);
		});
	}

	getRoles (user) {
		return new Promise((resolve, reject) => {
			setTimeout(() => {
			if(user === 'ellie') {
				resolve({name: 'ellie', role: 'admin'});
				} else {
					reject(new Error('no access'));
				}
			}, 1000);
		});
	}
}

const userStorage = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
userStorage.loginUser(id, password)
	.then(userStorage.getRoles) // user => userStorage.getRoles(user)
	.then(user => alert(`Hello ${user.name}, you have a ${user.role}`))
	.catch(console.log);
```
